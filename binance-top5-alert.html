<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Binance Top 5 Monitor + Alert</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    :root {
      --bg-dark: #0c0c0f;
      --bg-card: #14141a;
      --bg-row: #1a1a22;
      --bg-hover: #22222c;
      --accent-cyan: #00ffd5;
      --accent-pink: #ff2d92;
      --accent-yellow: #ffd000;
      --accent-blue: #00a8ff;
      --accent-red: #ff3366;
      --text-bright: #ffffff;
      --text-dim: #888899;
      --text-muted: #555566;
      --border: #2a2a35;
      --positive: #00e676;
      --negative: #ff1744;
      --font-mono: 'IBM Plex Mono', monospace;
      --font-sans: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 14px; }
    body { 
      font-family: var(--font-sans); 
      background: var(--bg-dark); 
      color: var(--text-bright); 
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app {
      min-height: 100vh;
      background: 
        radial-gradient(ellipse at 20% 0%, rgba(0, 255, 213, 0.05) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(255, 45, 146, 0.05) 0%, transparent 50%),
        var(--bg-dark);
    }

    .app.alert-active {
      animation: alertPulse 1s ease infinite;
    }

    @keyframes alertPulse {
      0%, 100% { box-shadow: inset 0 0 0 0 transparent; }
      50% { box-shadow: inset 0 0 100px rgba(255, 51, 102, 0.15); }
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(20, 20, 26, 0.9);
      backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
      gap: 12px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-text {
      font-family: var(--font-mono);
      font-size: 1rem;
      font-weight: 700;
    }

    .logo-text span { color: var(--accent-cyan); }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .status-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--bg-card);
      border-radius: 8px;
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }

    .ws-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .ws-dot.connected {
      background: var(--positive);
      box-shadow: 0 0 8px var(--positive);
      animation: pulse 2s infinite;
    }

    .ws-dot.connecting {
      background: var(--accent-yellow);
      animation: blink 0.5s infinite;
    }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

    /* Alert Button */
    .alert-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .alert-btn:hover {
      border-color: var(--accent-cyan);
    }

    .alert-btn.enabled {
      background: rgba(255, 51, 102, 0.15);
      border-color: var(--accent-red);
      color: var(--accent-red);
    }

    .alert-btn .icon { font-size: 1.1rem; }

    .alert-btn .switch {
      width: 32px;
      height: 18px;
      background: var(--bg-row);
      border-radius: 9px;
      position: relative;
    }

    .alert-btn .switch::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      background: var(--text-muted);
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: 0.2s;
    }

    .alert-btn.enabled .switch {
      background: var(--accent-red);
    }

    .alert-btn.enabled .switch::after {
      left: 16px;
      background: white;
    }

    /* Threshold Input */
    .threshold-box {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .threshold-box input {
      width: 50px;
      padding: 4px 8px;
      background: var(--bg-row);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--accent-yellow);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      text-align: center;
    }

    .threshold-box input:focus {
      outline: none;
      border-color: var(--accent-yellow);
    }

    /* Alert Banner */
    .alert-banner {
      display: none;
      padding: 16px 24px;
      background: linear-gradient(90deg, rgba(255, 51, 102, 0.2), rgba(255, 51, 102, 0.1));
      border-bottom: 2px solid var(--accent-red);
      animation: slideDown 0.3s ease;
    }

    .alert-banner.show {
      display: block;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .alert-content {
      max-width: 1800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .alert-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-icon {
      font-size: 1.5rem;
      animation: shake 0.5s ease infinite;
    }

    @keyframes shake {
      0%, 100% { transform: rotate(0); }
      25% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
    }

    .alert-text h3 {
      color: var(--accent-red);
      font-size: 1rem;
      font-weight: 600;
    }

    .alert-text p {
      color: var(--text-dim);
      font-size: 0.85rem;
      font-family: var(--font-mono);
    }

    .alert-tokens {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .alert-token {
      padding: 6px 12px;
      background: var(--accent-red);
      color: white;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      font-weight: 600;
      animation: popIn 0.3s ease;
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .dismiss-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--accent-red);
      color: var(--accent-red);
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 0.8rem;
      cursor: pointer;
      transition: 0.2s;
    }

    .dismiss-btn:hover {
      background: var(--accent-red);
      color: white;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      padding: 24px;
      max-width: 1800px;
      margin: 0 auto;
    }

    @media (max-width: 1200px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 30px rgba(0, 255, 213, 0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .card-icon.volatility { background: linear-gradient(135deg, var(--accent-pink), #ff6b6b); }
    .card-icon.funding { background: linear-gradient(135deg, var(--accent-yellow), #ff9500); }
    .card-icon.oi { background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); }

    .card-title h2 { font-size: 0.95rem; font-weight: 600; }
    .card-title p { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }

    .update-badge {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 4px 10px;
      background: var(--bg-row);
      border-radius: 6px;
    }

    /* Table */
    .table-container { padding: 8px; }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 4px;
    }

    .data-table th {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 12px;
      text-align: left;
    }

    .data-table td {
      padding: 12px;
      background: var(--bg-row);
      font-family: var(--font-mono);
      font-size: 0.85rem;
    }

    .data-table tr td:first-child { border-radius: 8px 0 0 8px; }
    .data-table tr td:last-child { border-radius: 0 8px 8px 0; }

    .data-table tbody tr {
      transition: all 0.2s ease;
      animation: fadeInUp 0.3s ease;
    }

    .data-table tbody tr:hover td { background: var(--bg-hover); }

    .data-table tbody tr.alert-row td {
      background: rgba(255, 51, 102, 0.15);
      animation: alertRowPulse 1s ease infinite;
    }

    @keyframes alertRowPulse {
      0%, 100% { background: rgba(255, 51, 102, 0.15); }
      50% { background: rgba(255, 51, 102, 0.25); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .rank {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.8rem;
    }

    .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
    .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
    .rank-3 { background: linear-gradient(135deg, #cd7f32, #a66528); color: #fff; }
    .rank-4, .rank-5 { background: var(--bg-card); color: var(--text-dim); border: 1px solid var(--border); }

    .symbol { font-weight: 600; color: var(--text-bright); }
    .value-positive { color: var(--positive); }
    .value-negative { color: var(--negative); }
    .value-hot { color: var(--accent-pink); font-weight: 600; }
    .value-alert { color: var(--accent-red); font-weight: 700; animation: textPulse 0.5s ease infinite; }

    @keyframes textPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .signal-tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .signal-long { background: rgba(0, 230, 118, 0.15); color: var(--positive); }
    .signal-short { background: rgba(255, 23, 68, 0.15); color: var(--negative); }
    .signal-bullish { background: rgba(0, 168, 255, 0.15); color: var(--accent-blue); }
    .signal-bearish { background: rgba(255, 45, 146, 0.15); color: var(--accent-pink); }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-icon { font-size: 2rem; margin-bottom: 12px; opacity: 0.5; }

    .loading-row td {
      background: linear-gradient(90deg, var(--bg-row) 0%, var(--bg-hover) 50%, var(--bg-row) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 20px;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.75rem;
      font-family: var(--font-mono);
    }

    .footer a { color: var(--accent-cyan); text-decoration: none; }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    // ==================== Constants ====================
    const WS_FUTURES = 'wss://fstream.binance.com/ws';
    const API_FUTURES = 'https://fapi.binance.com/fapi/v1';
    const API_FUTURES_DATA = 'https://fapi.binance.com/futures/data';
    const DEFAULT_ALERT_THRESHOLD = 5; // 5%

    // ==================== Audio Alert System ====================
    class AlertSound {
      constructor() {
        this.audioContext = null;
        this.initialized = false;
      }

      init() {
        if (this.initialized) return;
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          this.initialized = true;
        } catch (e) {
          console.error('Audio not supported:', e);
        }
      }

      play() {
        if (!this.initialized) this.init();
        if (!this.audioContext) return;

        try {
          const ctx = this.audioContext;
          const now = ctx.currentTime;

          // Create oscillators for alert sound
          const playTone = (freq, start, duration, type = 'sine') => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, now + start);
            
            gain.gain.setValueAtTime(0, now + start);
            gain.gain.linearRampToValueAtTime(0.3, now + start + 0.02);
            gain.gain.linearRampToValueAtTime(0, now + start + duration);
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.start(now + start);
            osc.stop(now + start + duration);
          };

          // Alert pattern: 3 beeps
          playTone(880, 0, 0.15, 'square');    // A5
          playTone(880, 0.2, 0.15, 'square');  // A5
          playTone(1320, 0.4, 0.25, 'square'); // E6 (higher pitch for urgency)
          
        } catch (e) {
          console.error('Error playing sound:', e);
        }
      }

      resume() {
        if (this.audioContext && this.audioContext.state === 'suspended') {
          this.audioContext.resume();
        }
      }
    }

    const alertSound = new AlertSound();

    // ==================== Utilities ====================
    const formatPercent = (num, decimals = 2) => {
      if (num == null || isNaN(num)) return '-';
      const sign = num >= 0 ? '+' : '';
      return `${sign}${num.toFixed(decimals)}%`;
    };

    const formatTime = (ts) => new Date(ts).toLocaleTimeString('zh-CN', { 
      hour: '2-digit', minute: '2-digit', second: '2-digit' 
    });

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // ==================== API Helpers ====================
    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function getTopSymbols(limit = 50) {
      try {
        const tickers = await fetchJSON(`${API_FUTURES}/ticker/24hr`);
        return tickers
          .filter(t => t.symbol.endsWith('USDT'))
          .sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
          .slice(0, limit)
          .map(t => t.symbol);
      } catch (e) {
        return [];
      }
    }

    async function getFundingRates() {
      try {
        const rates = await fetchJSON(`${API_FUTURES}/premiumIndex`);
        return rates
          .filter(r => r.symbol.endsWith('USDT'))
          .map(r => ({
            symbol: r.symbol,
            fundingRate: parseFloat(r.lastFundingRate) * 100,
          }))
          .sort((a, b) => Math.abs(b.fundingRate) - Math.abs(a.fundingRate))
          .slice(0, 5);
      } catch (e) {
        return [];
      }
    }

    async function getOpenInterestData(symbols) {
      const results = [];
      for (const symbol of symbols.slice(0, 20)) {
        try {
          const oiHist = await fetchJSON(
            `${API_FUTURES_DATA}/openInterestHist?symbol=${symbol}&period=5m&limit=30`
          ).catch(() => []);

          if (oiHist.length >= 2) {
            const latest = oiHist[0];
            const oldest = oiHist[oiHist.length - 1];
            
            const latestOI = parseFloat(latest.sumOpenInterest);
            const oldestOI = parseFloat(oldest.sumOpenInterest);
            const latestValue = parseFloat(latest.sumOpenInterestValue);
            const oldestValue = parseFloat(oldest.sumOpenInterestValue);

            if (oldestOI > 0 && oldestValue > 0) {
              const oiChange = ((latestOI - oldestOI) / oldestOI) * 100;
              const valueChange = ((latestValue - oldestValue) / oldestValue) * 100;
              const divergence = Math.abs(oiChange - valueChange);

              results.push({
                symbol,
                divergence,
                direction: oiChange > valueChange ? 'bearish' : 'bullish',
              });
            }
          }
          await sleep(100);
        } catch (e) {}
      }
      return results.sort((a, b) => b.divergence - a.divergence).slice(0, 5);
    }

    // ==================== WebSocket Hook ====================
    function useWebSocket(symbols) {
      const [klines, setKlines] = useState({});
      const [status, setStatus] = useState('disconnected');
      const wsRef = useRef(null);
      const reconnectRef = useRef(null);

      const connect = useCallback(() => {
        if (!symbols.length) return;

        const streams = symbols.map(s => `${s.toLowerCase()}@kline_5m`).join('/');
        setStatus('connecting');

        try {
          wsRef.current = new WebSocket(`${WS_FUTURES}/${streams}`);

          wsRef.current.onopen = () => setStatus('connected');

          wsRef.current.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              if (data.e === 'kline') {
                const k = data.k;
                setKlines(prev => ({
                  ...prev,
                  [data.s]: {
                    symbol: data.s,
                    open: parseFloat(k.o),
                    high: parseFloat(k.h),
                    low: parseFloat(k.l),
                    close: parseFloat(k.c),
                    time: k.t,
                  }
                }));
              }
            } catch (e) {}
          };

          wsRef.current.onclose = () => {
            setStatus('disconnected');
            reconnectRef.current = setTimeout(connect, 3000);
          };

          wsRef.current.onerror = () => wsRef.current?.close();
        } catch (e) {
          setStatus('error');
        }
      }, [symbols]);

      useEffect(() => {
        connect();
        return () => {
          clearTimeout(reconnectRef.current);
          wsRef.current?.close();
        };
      }, [connect]);

      return { klines, status };
    }

    // ==================== Components ====================
    function Header({ wsStatus, alertEnabled, setAlertEnabled, threshold, setThreshold }) {
      const [time, setTime] = useState(new Date());

      useEffect(() => {
        const timer = setInterval(() => setTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);

      const handleAlertToggle = () => {
        alertSound.init();
        alertSound.resume();
        setAlertEnabled(!alertEnabled);
      };

      return (
        <header className="header">
          <div className="logo">
            <div className="logo-icon">‚ö°</div>
            <div className="logo-text"><span>BINANCE</span> TOP5</div>
          </div>
          
          <div className="controls">
            <div className="status-box">
              <div className={`ws-dot ${wsStatus}`}></div>
              <span>{wsStatus === 'connected' ? 'LIVE' : wsStatus === 'connecting' ? '...' : 'OFF'}</span>
            </div>

            <div className="threshold-box">
              <span>ÈòàÂÄº:</span>
              <input 
                type="number" 
                value={threshold} 
                onChange={(e) => setThreshold(Math.max(0.1, parseFloat(e.target.value) || 5))}
                min="0.1"
                step="0.5"
              />
              <span>%</span>
            </div>

            <button 
              className={`alert-btn ${alertEnabled ? 'enabled' : ''}`}
              onClick={handleAlertToggle}
            >
              <span className="icon">{alertEnabled ? 'üîî' : 'üîï'}</span>
              <span>Êä•Ë≠¶</span>
              <div className="switch"></div>
            </button>

            <div className="status-box">{time.toLocaleTimeString('zh-CN')}</div>
          </div>
        </header>
      );
    }

    function AlertBanner({ alerts, onDismiss }) {
      if (alerts.length === 0) return null;

      return (
        <div className={`alert-banner ${alerts.length > 0 ? 'show' : ''}`}>
          <div className="alert-content">
            <div className="alert-info">
              <span className="alert-icon">üö®</span>
              <div className="alert-text">
                <h3>Ê≥¢Âä®ÂºÇÂ∏∏Ë≠¶Êä•!</h3>
                <p>‰ª•‰∏ã‰ª£Â∏Å5ÂàÜÈíüÊ≥¢Âä®ÁéáË∂ÖËøáÈòàÂÄº</p>
              </div>
            </div>
            <div className="alert-tokens">
              {alerts.map(a => (
                <span key={a.symbol} className="alert-token">
                  {a.symbol.replace('USDT', '')} {formatPercent(a.volatility)}
                </span>
              ))}
            </div>
            <button className="dismiss-btn" onClick={onDismiss}>ÂÖ≥Èó≠</button>
          </div>
        </div>
      );
    }

    function RankBadge({ rank }) {
      return <div className={`rank rank-${rank}`}>{rank}</div>;
    }

    function VolatilityCard({ data, lastUpdate, loading, threshold }) {
      return (
        <div className="card">
          <div className="card-header">
            <div className="card-title">
              <div className="card-icon volatility">üìä</div>
              <div>
                <h2>‰ª∑Ê†ºÊ≥¢Âä® TOP 5</h2>
                <p>5ÂàÜÈíüKÁ∫øÊ≥¢Âä®Áéá (Êä•Ë≠¶: &gt;{threshold}%)</p>
              </div>
            </div>
            <div className="update-badge">{lastUpdate ? formatTime(lastUpdate) : '-'}</div>
          </div>
          <div className="table-container">
            <table className="data-table">
              <thead>
                <tr><th>#</th><th>Symbol</th><th>Volatility</th><th>Change</th></tr>
              </thead>
              <tbody>
                {loading ? (
                  [...Array(5)].map((_, i) => (
                    <tr key={i} className="loading-row">
                      <td><RankBadge rank={i + 1} /></td>
                      <td>-</td><td>-</td><td>-</td>
                    </tr>
                  ))
                ) : data.length === 0 ? (
                  <tr><td colSpan="4"><div className="empty-state"><div className="empty-icon">üìä</div><div>Á≠âÂæÖÊï∞ÊçÆ...</div></div></td></tr>
                ) : (
                  data.map((item, i) => (
                    <tr key={item.symbol} className={item.volatility >= threshold ? 'alert-row' : ''}>
                      <td><RankBadge rank={i + 1} /></td>
                      <td className="symbol">{item.symbol.replace('USDT', '')}</td>
                      <td className={item.volatility >= threshold ? 'value-alert' : 'value-hot'}>
                        {formatPercent(item.volatility)}
                        {item.volatility >= threshold && ' üö®'}
                      </td>
                      <td className={item.priceChange >= 0 ? 'value-positive' : 'value-negative'}>
                        {formatPercent(item.priceChange)}
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function FundingCard({ data, lastUpdate, loading }) {
      return (
        <div className="card">
          <div className="card-header">
            <div className="card-title">
              <div className="card-icon funding">üí∞</div>
              <div><h2>ËµÑÈáëË¥πÁéá TOP 5</h2><p>ÁªùÂØπÂÄºÊúÄÂ§ß</p></div>
            </div>
            <div className="update-badge">{lastUpdate ? formatTime(lastUpdate) : '-'}</div>
          </div>
          <div className="table-container">
            <table className="data-table">
              <thead><tr><th>#</th><th>Symbol</th><th>Rate</th><th>Signal</th></tr></thead>
              <tbody>
                {loading ? (
                  [...Array(5)].map((_, i) => (
                    <tr key={i} className="loading-row"><td><RankBadge rank={i + 1} /></td><td>-</td><td>-</td><td>-</td></tr>
                  ))
                ) : data.length === 0 ? (
                  <tr><td colSpan="4"><div className="empty-state"><div className="empty-icon">üí∞</div><div>Á≠âÂæÖÊï∞ÊçÆ...</div></div></td></tr>
                ) : (
                  data.map((item, i) => (
                    <tr key={item.symbol}>
                      <td><RankBadge rank={i + 1} /></td>
                      <td className="symbol">{item.symbol.replace('USDT', '')}</td>
                      <td className={item.fundingRate >= 0 ? 'value-positive' : 'value-negative'}>{formatPercent(item.fundingRate, 4)}</td>
                      <td>
                        <span className={`signal-tag ${item.fundingRate > 0.03 ? 'signal-short' : item.fundingRate < -0.03 ? 'signal-long' : ''}`}>
                          {item.fundingRate > 0.03 ? 'SHORT' : item.fundingRate < -0.03 ? 'LONG' : 'NEUTRAL'}
                        </span>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function OICard({ data, lastUpdate, loading }) {
      return (
        <div className="card">
          <div className="card-header">
            <div className="card-title">
              <div className="card-icon oi">‚ö°</div>
              <div><h2>ÊåÅ‰ªìËÉåÁ¶ª TOP 5</h2><p>OI‰∏é‰ª∑ÂÄºÂèòÂåñËÉåÁ¶ª</p></div>
            </div>
            <div className="update-badge">{lastUpdate ? formatTime(lastUpdate) : '-'}</div>
          </div>
          <div className="table-container">
            <table className="data-table">
              <thead><tr><th>#</th><th>Symbol</th><th>Divergence</th><th>Signal</th></tr></thead>
              <tbody>
                {loading ? (
                  [...Array(5)].map((_, i) => (
                    <tr key={i} className="loading-row"><td><RankBadge rank={i + 1} /></td><td>-</td><td>-</td><td>-</td></tr>
                  ))
                ) : data.length === 0 ? (
                  <tr><td colSpan="4"><div className="empty-state"><div className="empty-icon">‚ö°</div><div>Á≠âÂæÖÊï∞ÊçÆ...</div></div></td></tr>
                ) : (
                  data.map((item, i) => (
                    <tr key={item.symbol}>
                      <td><RankBadge rank={i + 1} /></td>
                      <td className="symbol">{item.symbol.replace('USDT', '')}</td>
                      <td className="value-hot">{formatPercent(item.divergence)}</td>
                      <td>
                        <span className={`signal-tag ${item.direction === 'bullish' ? 'signal-bullish' : 'signal-bearish'}`}>
                          {item.direction === 'bullish' ? 'ÁúãÊ∂®ËÉåÁ¶ª' : 'ÁúãË∑åËÉåÁ¶ª'}
                        </span>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // ==================== Main App ====================
    function App() {
      const [symbols, setSymbols] = useState([]);
      const [volatilityTop5, setVolatilityTop5] = useState([]);
      const [fundingTop5, setFundingTop5] = useState([]);
      const [oiTop5, setOiTop5] = useState([]);
      const [loading, setLoading] = useState({ volatility: true, funding: true, oi: true });
      const [updates, setUpdates] = useState({ volatility: null, funding: null, oi: null });
      
      // Alert state
      const [alertEnabled, setAlertEnabled] = useState(false);
      const [threshold, setThreshold] = useState(DEFAULT_ALERT_THRESHOLD);
      const [activeAlerts, setActiveAlerts] = useState([]);
      const alertedRef = useRef(new Set()); // Track already alerted symbols

      const { klines, status } = useWebSocket(symbols);

      // Initialize
      useEffect(() => {
        getTopSymbols(50).then(setSymbols);
      }, []);

      // Calculate volatility and check alerts
      useEffect(() => {
        const entries = Object.values(klines);
        if (entries.length > 0) {
          const volatilityData = entries
            .map(k => {
              if (!k.open || k.open === 0) return null;
              return {
                symbol: k.symbol,
                volatility: ((k.high - k.low) / k.open) * 100,
                priceChange: ((k.close - k.open) / k.open) * 100,
              };
            })
            .filter(Boolean)
            .sort((a, b) => b.volatility - a.volatility)
            .slice(0, 5);

          if (volatilityData.length > 0) {
            setVolatilityTop5(volatilityData);
            setUpdates(prev => ({ ...prev, volatility: Date.now() }));
            setLoading(prev => ({ ...prev, volatility: false }));

            // Check for alerts
            if (alertEnabled) {
              const newAlerts = volatilityData.filter(d => 
                d.volatility >= threshold && !alertedRef.current.has(d.symbol)
              );

              if (newAlerts.length > 0) {
                // Play sound
                alertSound.play();
                
                // Add to active alerts
                setActiveAlerts(prev => {
                  const existing = new Set(prev.map(a => a.symbol));
                  const toAdd = newAlerts.filter(a => !existing.has(a.symbol));
                  return [...prev, ...toAdd];
                });

                // Mark as alerted (reset after 5 minutes)
                newAlerts.forEach(a => {
                  alertedRef.current.add(a.symbol);
                  setTimeout(() => alertedRef.current.delete(a.symbol), 5 * 60 * 1000);
                });
              }
            }
          }
        }
      }, [klines, alertEnabled, threshold]);

      // Funding rates
      useEffect(() => {
        const fetchFunding = async () => {
          const rates = await getFundingRates();
          if (rates.length > 0) {
            setFundingTop5(rates);
            setUpdates(prev => ({ ...prev, funding: Date.now() }));
            setLoading(prev => ({ ...prev, funding: false }));
          }
        };
        fetchFunding();
        const interval = setInterval(fetchFunding, 60000);
        return () => clearInterval(interval);
      }, []);

      // OI divergence
      useEffect(() => {
        const fetchOI = async () => {
          if (symbols.length === 0) return;
          const data = await getOpenInterestData(symbols);
          if (data.length > 0) {
            setOiTop5(data);
            setUpdates(prev => ({ ...prev, oi: Date.now() }));
            setLoading(prev => ({ ...prev, oi: false }));
          }
        };
        if (symbols.length > 0) {
          fetchOI();
          const interval = setInterval(fetchOI, 60000);
          return () => clearInterval(interval);
        }
      }, [symbols]);

      const dismissAlerts = () => setActiveAlerts([]);

      const hasActiveAlert = activeAlerts.length > 0 && alertEnabled;

      return (
        <div className={`app ${hasActiveAlert ? 'alert-active' : ''}`}>
          <Header 
            wsStatus={status}
            alertEnabled={alertEnabled}
            setAlertEnabled={setAlertEnabled}
            threshold={threshold}
            setThreshold={setThreshold}
          />
          
          <AlertBanner alerts={activeAlerts} onDismiss={dismissAlerts} />

          <div className="main-grid">
            <VolatilityCard 
              data={volatilityTop5} 
              lastUpdate={updates.volatility}
              loading={loading.volatility}
              threshold={threshold}
            />
            <FundingCard 
              data={fundingTop5}
              lastUpdate={updates.funding}
              loading={loading.funding}
            />
            <OICard 
              data={oiTop5}
              lastUpdate={updates.oi}
              loading={loading.oi}
            />
          </div>

          <footer className="footer">
            Data: <a href="https://www.binance.com" target="_blank">Binance API</a> | 
            Refresh: 1min | ‚ö†Ô∏è ‰ªÖ‰æõÂèÇËÄÉÔºå‰∏çÊûÑÊàêÊäïËµÑÂª∫ËÆÆ
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
